---
#Create an instance on MRC
- name: create an instance
  os_server:
    name: "{{item.name}}"
    image: "{{instance_image}}"
    key_name: "{{instance_key_name}}"
    flavor: "{{item.flavor}}"
    availability_zome: "{{availability_zone}}"
    security_groups: "{{sg_names}}"
    volumes: "{{item.volumes}}"
    auto_floating_ip: yes
    wait: yes
    timeout: 600
    state: present
  loop: "{{instances}}"
  register: os_instance

- debug:
    msg: "Instance {{item.openstack.name}} has been created. IP address is {{item.openstack.public_v4}}"
  loop: "{{os_instance.results}}"
  when: item.openstack is defined

#Need to make sure that we can connect via SSH (since sometimes there is some config
# that happens on cloud even after instance marked 'ready', and next task requires SSH)

- name: Wait for connection
  wait_for:
    host: "{{item.openstack.public_v4}}"
    port: 22
    timeout: 120
    search_regex: OpenSSH
  loop: "{{os_instance.results}}"
  when: item.openstack is defined
